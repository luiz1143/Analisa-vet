<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Comprar Créditos - AnalisaVet</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .credits-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .package {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .package:hover {
            border-color: #2196F3;
            background-color: #f8f9fa;
        }
        .package.selected {
            border-color: #2196F3;
            background-color: #e3f2fd;
        }
        .package-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .package-price {
            font-size: 24px;
            color: #2196F3;
            font-weight: bold;
        }
        .package-description {
            color: #666;
            margin-top: 5px;
        }
        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
        }
        .btn:hover {
            background: #1976D2;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-mode {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Teste - Comprar Créditos</h1>
            <p>Sistema de análise de hemogramas veterinários</p>
        </div>

        <div class="test-mode">
            <strong>MODO TESTE:</strong> Esta é uma simulação. Nenhum pagamento real será processado.
        </div>

        <div class="credits-info">
            <h3>Seus Créditos Atuais: <span id="current-credits">{{ current_user.credits or 0 }}</span></h3>
            <p>Cada análise de hemograma consome 1 crédito</p>
        </div>

        <div id="alert-container"></div>

        <h3>Escolha um Pacote de Créditos:</h3>

        <div id="packages-container">
            {% for package_id, package in packages.items() %}
            <div class="package" data-package-id="{{ package_id }}" onclick="selectPackage('{{ package_id }}')">
                <div class="package-title">{{ package.descricao }}</div>
                <div class="package-price">R$ {{ "%.2f"|format(package.preco) }}</div>
                <div class="package-description">
                    {{ package.creditos }} crédito{% if package.creditos > 1 %}s{% endif %}
                    {% if package_id != '1' %}
                    - Economia de {{ ((package.creditos * 2.00 - package.preco) / (package.creditos * 2.00) * 100)|round|int }}%
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <button class="btn" id="simulate-payment-btn" onclick="simulatePayment()" disabled>
            Simular Pagamento
        </button>

        <div style="margin-top: 30px; text-align: center;">
            <a href="/" style="color: #2196F3; text-decoration: none;">← Voltar ao Início</a>
        </div>
    </div>

    <script>
        let selectedPackage = null;

        function selectPackage(packageId) {
            // Remove seleção anterior
            document.querySelectorAll('.package').forEach(pkg => {
                pkg.classList.remove('selected');
            });
            
            // Adiciona seleção atual
            document.querySelector(`[data-package-id="${packageId}"]`).classList.add('selected');
            selectedPackage = packageId;
            
            // Habilita botão
            document.getElementById('simulate-payment-btn').disabled = false;
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            
            // Remove alerta após 5 segundos
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        function simulatePayment() {
            if (!selectedPackage) {
                showAlert('Por favor, selecione um pacote de créditos.', 'error');
                return;
            }

            const btn = document.getElementById('simulate-payment-btn');
            btn.disabled = true;
            btn.textContent = 'Processando...';

            fetch('/test-payment/simulate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    package_id: selectedPackage
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    
                    // Atualizar créditos na tela
                    document.getElementById('current-credits').textContent = data.data.total_credits;
                    
                    // Reset seleção
                    document.querySelectorAll('.package').forEach(pkg => {
                        pkg.classList.remove('selected');
                    });
                    selectedPackage = null;
                } else {
                    showAlert(data.error || 'Erro ao processar pagamento.', 'error');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showAlert('Erro de conexão. Tente novamente.', 'error');
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'Simular Pagamento';
            });
        }

        // Função para adicionar créditos diretamente (para teste)
        function addCreditsDirectly(credits) {
            fetch('/test-payment/add-credits', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    credits: credits
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    document.getElementById('current-credits').textContent = data.total_credits;
                } else {
                    showAlert(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showAlert('Erro de conexão.', 'error');
            });
        }
    </script>
</body>
</html>

